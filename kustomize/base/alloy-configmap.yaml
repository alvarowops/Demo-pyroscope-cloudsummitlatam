apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: observability
data:
  config.alloy: |
    logging {
      level  = "info"
      format = "logfmt"
    }

    // Discover Java pods with pyroscope annotation
    discovery.kubernetes "pods" {
      role = "pod"
    }

    discovery.relabel "java_pods" {
      targets = discovery.kubernetes.pods.targets

      rule {
        source_labels = ["__meta_kubernetes_pod_annotation_pyroscope_grafana_com_scrape"]
        action        = "keep"
        regex         = "true"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_annotation_pyroscope_grafana_com_application_name"]
        target_label  = "service_name"
        action        = "replace"
      }

      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
        action        = "replace"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
        action        = "replace"
      }

      rule {
        source_labels = ["__meta_kubernetes_pod_container_id"]
        target_label  = "__container_id__"
        action        = "replace"
      }
    }

    // Auto-instrumentation for Java using async-profiler
    pyroscope.java "java_pods" {
      targets    = discovery.relabel.java_pods.output
      forward_to = [pyroscope.write.grafana_cloud.receiver]

      profiling_config {
        interval   = "15s"
        cpu        = true
        alloc      = "512k"
        lock       = "10ms"
      }
    }

    pyroscope.write "grafana_cloud" {
      endpoint {
        url = env("PYROSCOPE_REMOTE_WRITE")
        basic_auth {
          username = env("GRAFANA_CLOUD_USER")
          password = env("GRAFANA_CLOUD_API_KEY")
        }
      }
    }

    prometheus.scrape "alloy" {
      targets = [
        {"__address__" = "127.0.0.1:12345", "job" = "alloy"},
      ]
      forward_to = [prometheus.remote_write.grafana_cloud.receiver]
    }

    prometheus.remote_write "grafana_cloud" {
      endpoint {
        url = env("PROM_REMOTE_WRITE")
        basic_auth {
          username = env("GRAFANA_CLOUD_USER")
          password = env("GRAFANA_CLOUD_API_KEY")
        }
      }
    }
