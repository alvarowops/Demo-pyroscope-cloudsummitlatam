apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: observability
data:
  config.alloy: |
    logging {
      level  = "info"
      format = "logfmt"
    }

    // Discover pods - filter by namespace where Java apps run
    discovery.kubernetes "pods" {
      role = "pod"
      namespaces {
        names = ["default"]
      }
    }

    // Discover processes and join with Kubernetes pod discovery
    // The join merges kubernetes and process data using container_id
    discovery.process "all" {
      join = discovery.kubernetes.pods.targets
    }

    // Filter Java processes and set labels
    discovery.relabel "java" {
      targets = discovery.process.all.targets

      // Keep only java processes
      rule {
        source_labels = ["__meta_process_exe"]
        action        = "keep"
        regex         = ".*/java$"
      }

      // Set service_name from namespace/container
      rule {
        source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_container_name"]
        target_label  = "service_name"
        separator     = "/"
      }

      // Set node label
      rule {
        action        = "replace"
        source_labels = ["__meta_kubernetes_pod_node_name"]
        target_label  = "node"
      }

      // Set namespace label
      rule {
        action        = "replace"
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }

      // Set pod label
      rule {
        action        = "replace"
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }

      // Set container label
      rule {
        action        = "replace"
        source_labels = ["__meta_kubernetes_pod_container_name"]
        target_label  = "container"
      }
    }

    // Auto-instrumentation for Java using async-profiler
    pyroscope.java "java" {
      profiling_config {
        interval    = "15s"
        cpu         = true
        sample_rate = 100
        alloc       = "512k"
        lock        = "10ms"
      }
      forward_to = [pyroscope.write.grafana_cloud.receiver]
      targets    = discovery.relabel.java.output
    }

    pyroscope.write "grafana_cloud" {
      endpoint {
        url = env("PYROSCOPE_REMOTE_WRITE")
        basic_auth {
          username = env("GRAFANA_CLOUD_USER")
          password = env("GRAFANA_CLOUD_API_KEY")
        }
      }
      external_labels = {
        cluster = "pyroscope-demo",
        agent   = "grafana-alloy",
      }
    }

    prometheus.scrape "alloy" {
      targets = [
        {"__address__" = "127.0.0.1:12345", "job" = "alloy"},
      ]
      forward_to = [prometheus.remote_write.grafana_cloud.receiver]
    }

    prometheus.remote_write "grafana_cloud" {
      endpoint {
        url = env("PROM_REMOTE_WRITE")
        basic_auth {
          username = env("GRAFANA_CLOUD_USER")
          password = env("GRAFANA_CLOUD_API_KEY")
        }
      }
    }
