apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: observability
data:
  config.alloy: |
    logging {
      level  = "info"
      format = "logfmt"
    }

    // Discover pods on the same node as Alloy
    discovery.kubernetes "local_pods" {
      selectors {
        field = "spec.nodeName=" + env("HOSTNAME")
        role  = "pod"
      }
      role = "pod"
    }

    // Discover processes and join with Kubernetes pod discovery
    discovery.process "all" {
      join = discovery.kubernetes.local_pods.targets
    }

    // Filter and relabel Java processes
    discovery.relabel "java_pods" {
      targets = discovery.process.all.targets

      // Filter only java processes
      rule {
        source_labels = ["__meta_process_exe"]
        action        = "keep"
        regex         = ".*/java$"
      }

      // Drop pods that are not running
      rule {
        action        = "drop"
        regex         = "Succeeded|Failed|Completed"
        source_labels = ["__meta_kubernetes_pod_phase"]
      }

      // Keep only pods with pyroscope scrape annotation
      rule {
        source_labels = ["__meta_kubernetes_pod_annotation_pyroscope_grafana_com_scrape"]
        action        = "keep"
        regex         = "true"
      }

      // Set namespace label
      rule {
        action        = "replace"
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }

      // Set pod label
      rule {
        action        = "replace"
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }

      // Set node label
      rule {
        action        = "replace"
        source_labels = ["__meta_kubernetes_pod_node_name"]
        target_label  = "node"
      }

      // Set container label
      rule {
        action        = "replace"
        source_labels = ["__meta_kubernetes_pod_container_name"]
        target_label  = "container"
      }

      // Set service_name from annotation or infer from namespace/container
      rule {
        action        = "replace"
        source_labels = ["__meta_kubernetes_pod_annotation_pyroscope_grafana_com_application_name"]
        target_label  = "service_name"
      }
    }

    // Auto-instrumentation for Java using async-profiler
    pyroscope.java "java" {
      forward_to = [pyroscope.write.grafana_cloud.receiver]
      targets    = discovery.relabel.java_pods.output

      profiling_config {
        interval    = "15s"
        cpu         = true
        sample_rate = 100
        alloc       = "512k"
        lock        = "10ms"
      }
    }

    pyroscope.write "grafana_cloud" {
      endpoint {
        url = env("PYROSCOPE_REMOTE_WRITE")
        basic_auth {
          username = env("GRAFANA_CLOUD_USER")
          password = env("GRAFANA_CLOUD_API_KEY")
        }
      }
    }

    prometheus.scrape "alloy" {
      targets = [
        {"__address__" = "127.0.0.1:12345", "job" = "alloy"},
      ]
      forward_to = [prometheus.remote_write.grafana_cloud.receiver]
    }

    prometheus.remote_write "grafana_cloud" {
      endpoint {
        url = env("PROM_REMOTE_WRITE")
        basic_auth {
          username = env("GRAFANA_CLOUD_USER")
          password = env("GRAFANA_CLOUD_API_KEY")
        }
      }
    }
